#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import argparse
import os
import pandas as pd
import re
import numpy as np
import matplotlib.pyplot as plt
from collections import defaultdict


# user_extracted.txt から *_read のみ抽出
def read_user_file(path):
    data = {}
    with open(path, "r") as f:
        for line in f:
            line = line.strip()

            # *_read = 数値 のみ拾う（dir は無視）
            m = re.match(r"([A-Za-z0-9_]+_read)\s*=\s*([0-9eE+\-\.]+)", line)
            if m:
                key = m.group(1)
                val = float(m.group(2))
                data[key] = val

    return data


# 行番号 row のすべてのタスク read を集める
def collect_reads(parent_dir, row, cols):
    results = {}

    node_dirs = [f"NODE_{row:08}_{col:08}" for col in cols]

    for node_dir in node_dirs:
        ux = os.path.join(parent_dir, node_dir, "user_extracted.txt")
        if not os.path.isfile(ux):
            continue

        data = read_user_file(ux)

        # 各ファイルに 1 つの *_read が入っている前提
        for key, val in data.items():
            if key.endswith("_read"):
                action = key.replace("_read", "")
                results[action] = val

    return results


# Lg 読み込み
def load_lg_map(parent_dir):
    lg_map = {}
    with open(os.path.join(parent_dir, "lg_map.txt"), "r") as f:
        for line in f:
            row, lg = line.split()
            lg_map[int(row)] = float(lg)
    return lg_map


# parent_dir 1つ分の DataFrame を作成
def read_sim_data(parent_dir, rows, cols):
    lg_map = load_lg_map(parent_dir)
    df_rows = []

    for row in rows:
        reads = collect_reads(parent_dir, row, cols)
        print(f"[{parent_dir}] row = {row}, reads = {reads}")

        if row not in lg_map:
            continue

        Lg = lg_map[row]

        row_dict = {"Lg": Lg}
        for action, val in reads.items():
            row_dict[action] = val

        df_rows.append(row_dict)

    df = pd.DataFrame(df_rows)
    df["source"] = os.path.basename(parent_dir)  # どの parent_dir か識別用

    return df


def plot_multi(dfs):
    fig: plt.Figure
    axes: plt.Axes
    plt.rcParams["font.size"] = 16
    fig, axes = plt.subplots(1, 3, figsize=(15, 5), sharey=False)
    ax1, ax2, ax3 = axes

    colors = plt.cm.tab10.colors
    color_idx = 0

    for idx, df in enumerate(dfs):
        df = df.copy()
        label = f"sim{idx}"   # ★ ここで凡例名を決定

        # ratio 列を追加
        df["ratio"] = df["init1"] / df["init0"]
        df["ratio_hold"] = df["program1"] / df["program0"]

        df = df.sort_values("Lg")

        c = colors[color_idx % len(colors)]
        color_idx += 1

        # subplot 1: init0 / program0
        ax1.plot(df["Lg"], df["init0"], marker='o', label=f"init0 ({label})", color=c)
        ax1.plot(df["Lg"], df["program0"], marker='s', linestyle='--',
                 label=f"program0 ({label})", color=c)

        # subplot 2: init1 / program1
        ax2.plot(df["Lg"], df["init1"], marker='o', label=f"init1 ({label})", color=c)
        ax2.plot(df["Lg"], df["program1"], marker='s', linestyle='--',
                 label=f"program1 ({label})", color=c)

        # subplot 3: ratio / ratio_hold
        ax3.plot(df["Lg"], df["ratio"], marker='o', label=f"ratio ({label})", color=c)
        ax3.plot(df["Lg"], df["ratio_hold"], marker='s', linestyle='--',
                 label=f"ratio_hold ({label})", color=c)

    # subplot 1
    ax1.set_title("init0 / program0")
    ax1.set_xlabel("Gate length Lg")
    ax1.set_ylabel("Read current (A)")
    ax1.grid(True)
    ax1.set_yscale("log")
    ax1.legend()

    # subplot 2
    ax2.set_title("init1 / program1")
    ax2.set_xlabel("Gate length Lg")
    ax2.set_ylabel("Read current (A)")
    ax2.grid(True)
    ax2.set_yscale("log")
    ax2.legend()

    # subplot 3
    ax3.set_title("ratio / ratio_hold")
    ax3.set_xlabel("Gate length Lg")
    ax3.set_ylabel("Ratio")
    ax3.grid(True)
    ax3.set_yscale("log")
    ax3.legend()

    plt.tight_layout()
    plt.show()


if __name__ == "__main__":

    parser = argparse.ArgumentParser()
    parser.add_argument('twb_dirs', type=str, nargs='+',
                        help="複数の parent directory を指定")
    parser.add_argument('-r', '--rows', type=int, nargs='+', default=[1])
    parser.add_argument('-c', '--cols', type=int, nargs='+', default=[2, 3, 4, 5])
    args = parser.parse_args()

    twb_dirs = args.twb_dirs
    rows = args.rows
    cols = args.cols

    print(f"twb_dirs= {twb_dirs}")
    print(f"rows = {rows}")
    print(f"cols = {cols}")

    dfs = []
    for d in twb_dirs:
        df_sim = read_sim_data(d, rows, cols)
        print(f"\n=== DataFrame ({d}) ===")
        print(df_sim)
        dfs.append(df_sim)

    plot_multi(dfs)
