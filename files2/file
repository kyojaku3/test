#!/bin/bash

matsim=$HOME/code/Work_nnp/MatterSim/matsimase.py

work_dir=$1
#poscar_filepath="POSCAR_In2O3/POSCAR_In2O3_conventional_2218907"
poscar_filepath=$2
echo "work_dir=$work_dir"
echo "poscar_filepath=$poscar_filepath"

test ! -e $work_dir && mkdir $work_dir

poscar_file=$(basename $poscar_filepath)
cp $poscar_filepath $work_dir

cd $work_dir

O_indices=($(ase convert $poscar_file tmp.vasp -f \
 -e "print([idx for idx,elem in enumerate(atoms.get_chemical_symbols()) if elem=='O'])" \
| sed -e "s/,//g" | sed -e "s/\[//g" | sed -e "s/\]//g"))

n_O=${#O_indices[@]}
echo "number of O atoms = $n_O"

for((idx=1;idx<=$n_O;idx++)); do
  idx_O=${O_indices[$idx - 1]}
  echo $idx $idx_O

  test ! -e $idx && mkdir $idx
  if [ ! -e $idx/POSCAR ]; then
    ase convert $poscar_file $idx/POSCAR -f -e "atoms.pop($idx_O); atoms.rattle(stdev=0.1,seed=12345)"
  fi

  cd $idx
  python3 $matsim POSCAR relax
  cd ..

#  exit
done


